<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
        }

        body {
            background-color: #f5f6fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 600;
            color: white !important;
        }

        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            padding: 1.5rem;
        }

        .section-header {
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .stats-card {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .table {
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        .table th {
            background-color: var(--light-bg);
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .table td {
            vertical-align: middle;
        }

        .positive {
            color: var(--success-color);
            font-weight: 500;
        }

        .negative {
            color: var(--danger-color);
            font-weight: 500;
        }

        .nav-tabs .nav-link {
            color: var(--secondary-color);
            border: none;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
            background: none;
        }

        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.375rem 0.75rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .summary-card h3 {
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .badge {
            padding: 0.5em 0.75em;
            font-weight: 500;
        }

        .badge-buy {
            background-color: var(--success-color);
        }

        .badge-sell {
            background-color: var(--danger-color);
        }

        @media (max-width: 768px) {
            .section {
                padding: 1rem;
            }

            .table {
                font-size: 0.8rem;
            }
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .back-to-top:hover {
            background-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .back-to-top:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .back-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }

        /* Date Range Selector */
        .date-range-selector {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .date-range-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: end;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .date-input-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .date-input-group input {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .preset-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            border: 1px solid var(--accent-color);
            background: white;
            color: var(--accent-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover, .preset-btn.active {
            background: var(--accent-color);
            color: white;
        }

        @media (max-width: 768px) {
            .date-range-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .date-input-group {
                min-width: 100%;
            }

            .preset-buttons {
                justify-content: center;
            }
        }

        /* Performance Cards Styles */
        .performance-card {
            border: 1px solid #e3e6f0;
            border-radius: 0.75rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: transform 0.2s ease-in-out;
        }

        .performance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
        }

        .performance-card .card-body {
            padding: 1.25rem;
        }

        .performance-card h4 {
            font-weight: 700;
            color: #5a5c69;
            margin: 0;
        }

        .performance-card .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .performance-details {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e3e6f0;
        }

        .performance-details small {
            font-size: 0.8rem;
        }

        /* Analytics Cards Styles */
        .analytics-card {
            border: 1px solid #e3e6f0;
            border-radius: 0.75rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: transform 0.2s ease-in-out;
        }

        .analytics-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
        }

        .analytics-card .card-body {
            padding: 1.5rem;
        }

        .analytics-card h4 {
            font-weight: 700;
            color: #5a5c69;
            margin: 0;
            font-size: 1.75rem;
        }

        .analytics-icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .analytics-card small {
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Connection Status and Notifications */
        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .connection-banner {
            margin: 0 1rem 1rem 1rem;
            border-radius: 8px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
        }

        /* Loading indicator improvements */
        #loadingIndicator {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            font-weight: 500;
            padding: 15px;
        }

        /* Connection status button improvements */
        .btn-outline-light:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-outline-light:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Account Overview Styles */
        .account-overview .card {
            border: 1px solid #e3e6f0;
            border-radius: 0.75rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: transform 0.2s ease-in-out;
        }

        .account-overview .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
        }

        .account-overview .card-header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom: none;
            border-radius: 0.75rem 0.75rem 0 0 !important;
        }

        .account-overview .card-header h6 {
            margin: 0;
            font-weight: 600;
        }

        .account-overview .card-body {
            padding: 1.5rem;
        }

        .account-overview .fw-bold {
            font-weight: 600 !important;
        }

        .account-overview hr {
            margin: 1rem 0;
            opacity: 0.2;
        }

        .account-overview .text-muted {
            font-size: 0.9rem;
        }

        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            transition: color 0.3s ease;
            position: relative;
        }

        .navbar-nav .nav-link:hover {
            color: white !important;
        }

        .navbar-nav .nav-link.active {
            color: white !important;
        }

        .navbar-nav .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background-color: white;
            border-radius: 1px;
        }

        /* Scroll offset for fixed navbar */
        html {
            scroll-padding-top: 80px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up"></i> Trading Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview"><i class="bi bi-house"></i> Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#performance"><i class="bi bi-graph-up-arrow"></i> Performance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#positions"><i class="bi bi-briefcase"></i> Positions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#analytics"><i class="bi bi-bar-chart"></i> Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#put-analysis"><i class="bi bi-graph-down"></i> Put Analysis</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Connection Status Banner -->
    {% if data.connection_status is defined %}
    <div id="connectionBanner" class="alert alert-{% if data.connection_status.connected %}success{% else %}danger{% endif %} alert-dismissible fade show" role="alert" style="margin: 0 1rem 1rem 1rem;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-{% if data.connection_status.connected %}wifi{% else %}wifi-off{% endif %}"></i>
                <strong>IBKR Connection:</strong>
                {% if data.connection_status.connected %}
                    Connected
                {% else %}
                    Disconnected
                    {% if data.connection_status.error_message %}
                        - {{ data.connection_status.error_message }}
                    {% endif %}
                {% endif %}
                {% if data.connection_status.retry_count > 0 %}
                    <small class="ms-2">(Retry count: {{ data.connection_status.retry_count }})</small>
                {% endif %}
            </div>
            <div>
                {% if not data.connection_status.connected %}
                <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="attemptReconnect()">
                    <i class="bi bi-arrow-clockwise"></i> Reconnect
                </button>
                <a href="{{ data.connection_status.gateway_url }}" target="_blank" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-box-arrow-up-right"></i> IBKR Login
                </a>
                {% endif %}
                <button type="button" class="btn btn-sm btn-outline-light" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- No Data Message -->
    {% if data.connection_status is defined and not data.connection_status.connected %}
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h4 class="mt-3 text-warning">No Data Available</h4>
                        <p class="text-muted">
                            The dashboard is currently disconnected from IBKR. This usually happens when:
                        </p>
                        <ul class="text-muted text-start">
                            <li>The IBKR session has expired</li>
                            <li>The IBKR Gateway is not running</li>
                            <li>There are network connectivity issues</li>
                            <li>Authentication credentials need to be refreshed</li>
                        </ul>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i>
                            <strong>IBKR Gateway:</strong> This is the authentication interface for Interactive Brokers.
                            Use it to log in and maintain your session. The dashboard connects to IBKR through this gateway.
                        </div>
                        <div class="mt-4">
                            <button type="button" class="btn btn-warning me-2" onclick="attemptReconnect()">
                                <i class="bi bi-arrow-clockwise"></i> Try Reconnecting
                            </button>
                            <a href="{{ data.connection_status.gateway_url }}" target="_blank" class="btn btn-info me-2">
                                <i class="bi bi-box-arrow-up-right"></i> Open IBKR Gateway
                            </a>
                            <button type="button" class="btn btn-outline-secondary" onclick="refreshData()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Data
                            </button>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                Last check: {{ data.connection_status.last_check or 'Never' }}
                                {% if data.connection_status.retry_count > 0 %}
                                <br>Retry attempts: {{ data.connection_status.retry_count }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Loading Indicator -->
    <div id="loadingIndicator" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: white; text-align: center; padding: 10px; z-index: 1000;">
        Loading data...
    </div>

    <!-- Error Message -->
    {% if error is defined and error %}
    <div class="container-fluid">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong> {{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
    {% endif %}

    <!-- Main Dashboard Content (only show when connected) -->
    {% if data.connection_status is defined and data.connection_status.connected %}
    <div class="container-fluid py-4">
        <!-- Account Overview (Combined Account Information and Ledger) -->
        <div id="overview" class="section mb-4 account-overview">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0"><i class="bi bi-person-circle"></i> Account Overview</h2>
                {% if data.account_status is defined %}
                <span class="badge {% if data.account_status.connection_status == 'Connected' %}bg-success{% else %}bg-danger{% endif %}">
                    {{ data.account_status.connection_status }}
                </span>
                {% endif %}
            </div>

            <div class="row">
                <!-- Account Information -->
                {% if data.account_info is defined %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-person-circle"></i> Account Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Account ID:</span>
                                        <span class="fw-bold">{{ data.account_info.account_id or 'N/A' }}</span>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Name:</span>
                                        <span class="fw-bold">{{ data.account_info.name or 'N/A' }}</span>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Type:</span>
                                        <span class="fw-bold">{{ data.account_info.type or 'N/A' }}</span>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Currency:</span>
                                        <span class="fw-bold">{{ data.account_info.currency or 'N/A' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Account Balances -->
                {% if data.account_status is defined and data.account_status.balances %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-wallet2"></i> Account Balances</h6>
                        </div>
                        <div class="card-body">
                            {% for currency, balance in data.account_status.balances.items() %}
                            {% if balance.ledger_balance is defined or balance.settled_balance is defined or balance.pending_balance is defined %}
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="bi bi-currency-{{ currency.lower() }}"></i> {{ currency }} Balances
                                </h6>

                                {% if balance.ledger_balance is defined and balance.ledger_balance != 0 %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Ledger Balance:</span>
                                    <span class="{% if balance.ledger_balance >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                        ${{ "%.2f"|format(balance.ledger_balance) }}
                                    </span>
                                </div>
                                {% endif %}

                                {% if balance.settled_balance is defined and balance.settled_balance != 0 %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Settled Balance:</span>
                                    <span class="{% if balance.settled_balance >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                        ${{ "%.2f"|format(balance.settled_balance) }}
                                    </span>
                                </div>
                                {% endif %}

                                {% if balance.pending_balance is defined and balance.pending_balance != 0 %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Pending Balance:</span>
                                    <span class="{% if balance.pending_balance >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                        ${{ "%.2f"|format(balance.pending_balance) }}
                                    </span>
                                </div>
                                {% endif %}

                                {% if not loop.last %}
                                <hr class="my-3">
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Performance Cards -->
        {% if data.performance is defined %}
        <div id="performance" class="section mb-4">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0"><i class="bi bi-graph-up-arrow"></i> Account Performance</h2>
            </div>
            <div class="row">
                {% if data.performance %}
                    {% for period, perf in data.performance.items() %}
                        {% if perf %}
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card performance-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="card-title text-muted mb-1">{{ period }}</h6>
                                            <h4 class="mb-2">${{ "%.2f"|format(perf.current_nav) }}</h4>
                                        </div>
                                        <div class="text-end">
                                            {% if perf.returns_pct >= 0 %}
                                                <span class="badge bg-success">+{{ "%.2f"|format(perf.returns_pct) }}%</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ "%.2f"|format(perf.returns_pct) }}%</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="performance-details">
                                        <small class="text-muted">
                                            Change:
                                            {% if perf.nav_change >= 0 %}
                                                <span class="text-success">+${{ "%.2f"|format(perf.nav_change) }}</span>
                                            {% else %}
                                                <span class="text-danger">${{ "%.2f"|format(perf.nav_change) }}</span>
                                            {% endif %}
                                        </small>
                                        <br>
                                        <small class="text-muted">
                                            Return:
                                            {% if perf.returns_pct >= 0 %}
                                                <span class="text-success">+{{ "%.2f"|format(perf.returns_pct) }}%</span>
                                            {% else %}
                                                <span class="text-danger">{{ "%.2f"|format(perf.returns_pct) }}%</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Performance data not available
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Positions Section -->
        <div id="positions" class="section">
            <div class="section-header">
                <h2 class="h4 mb-0"><i class="bi bi-briefcase"></i> Current Positions</h2>
            </div>

            <ul class="nav nav-tabs mb-4" id="positionsTab" role="tablist">
                {% if data.positions is defined %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="stocks-tab" data-bs-toggle="tab" data-bs-target="#stocks" type="button">
                        <i class="bi bi-bar-chart"></i> Stocks
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options" type="button">
                        <i class="bi bi-option"></i> Options
                    </button>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content" id="positionsTabContent">
                <div class="tab-pane fade show active" id="stocks">
                    <div class="table-responsive">
                        <table class="table table-hover" id="stockPositionsTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Market Price</th>
                                    <th>Market Value</th>
                                    <th>Avg Cost</th>
                                    <th>Unrealized P&L</th>
                                    <th>Realized P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for _, row in data.positions.iterrows() %}
                                {% if row['assetClass'] == 'STK' %}
                                <tr>
                                    <td><strong>{{ row['ticker'] }}</strong></td>
                                    <td>{{ row['fullName'] }}</td>
                                    <td>{{ row['position'] }}</td>
                                    <td>${{ "%.2f"|format(row['mktPrice']) }}</td>
                                    <td>${{ "%.2f"|format(row['mktValue']) }}</td>
                                    <td>${{ "%.2f"|format(row['avgCost']) }}</td>
                                    <td class="{{ 'positive' if row['unrealizedPnl'] > 0 else 'negative' }}">
                                        ${{ "%.2f"|format(row['unrealizedPnl']) }}
                                    </td>
                                    <td class="{{ 'positive' if row['realizedPnl'] > 0 else 'negative' }}">
                                        ${{ "%.2f"|format(row['realizedPnl']) }}
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="options">
                    <div class="table-responsive">
                        <table class="table table-hover" id="optionPositionsTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Description</th>
                                    <th>Type</th>
                                    <th>Expiration</th>
                                    <th>Strike</th>
                                    <th>Quantity</th>
                                    <th>Market Price</th>
                                    <th>Market Value</th>
                                    <th>Avg Price</th>
                                    <th>Avg Cost</th>
                                    <th>Unrealized P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for _, row in data.positions.iterrows() %}
                                {% if row['assetClass'] == 'OPT' %}
                                <tr>
                                    <td><strong>{{ row['ticker'] }}</strong></td>
                                    <td>{{ row['fullName'] }}</td>
                                    <td>
                                        <span
                                            class="badge {% if row['putOrCall'] == 'P' %}bg-danger{% else %}bg-success{% endif %}">
                                            {{ row['putOrCall'] }}
                                        </span>
                                    </td>
                                    <td>{{ row['expiry'] }}</td>
                                    <td>${{ "%.2f"|format(row['strike']) }}</td>
                                    <td>{{ row['position'] }}</td>
                                    <td>${{ "%.2f"|format(row['mktPrice']) }}</td>
                                    <td>${{ "%.2f"|format(row['mktValue']) }}</td>
                                    <td>${{ "%.2f"|format(row['avgPrice']) }}</td>
                                    <td>${{ "%.2f"|format(row['avgCost']) }}</td>
                                    <td class="{{ 'positive' if row['unrealizedPnl'] > 0 else 'negative' }}">
                                        ${{ "%.2f"|format(row['unrealizedPnl']) }}
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Position Analytics -->
        {% if data.position_analytics is defined %}
        <div id="analytics" class="section mb-4">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0"><i class="bi bi-bar-chart"></i> Position Analytics</h2>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-briefcase text-primary"></i>
                            </div>
                            <h4 class="mb-1">{{ data.position_analytics.total_positions }}</h4>
                            <small class="text-muted">Total Positions</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-currency-dollar text-success"></i>
                            </div>
                            <h4 class="mb-1">${{ "%.2f"|format(data.position_analytics.total_value) }}</h4>
                            <small class="text-muted">Total Value</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                {% if data.position_analytics.unrealized_pnl >= 0 %}
                                    <i class="bi bi-graph-up-arrow text-success"></i>
                                {% else %}
                                    <i class="bi bi-graph-down-arrow text-danger"></i>
                                {% endif %}
                            </div>
                            <h4 class="mb-1 {% if data.position_analytics.unrealized_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ${{ "%.2f"|format(data.position_analytics.unrealized_pnl) }}
                            </h4>
                            <small class="text-muted">Unrealized P&L</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-percent text-info"></i>
                            </div>
                            <h4 class="mb-1 {% if data.position_analytics.unrealized_pnl_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "%.2f"|format(data.position_analytics.unrealized_pnl_pct) }}%
                            </h4>
                            <small class="text-muted">P&L %</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collateral Usage -->
            {% if data.position_analytics.collateral_usage is defined %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-shield-lock"></i> Collateral Usage</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="text-center">
                                        <div class="h4 mb-1 text-primary">${{ "%.2f"|format(data.position_analytics.collateral_usage.total_collateral) }}</div>
                                        <small class="text-muted">Total Collateral</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="text-center">
                                        <div class="h4 mb-1 text-info">${{ "%.2f"|format(data.position_analytics.collateral_usage.total_account_value) }}</div>
                                        <small class="text-muted">Total Account Value</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="text-center">
                                        <div class="h4 mb-1 {% if data.position_analytics.collateral_usage.collateral_percentage > 50 %}text-danger{% elif data.position_analytics.collateral_usage.collateral_percentage > 30 %}text-warning{% else %}text-success{% endif %}">
                                            {{ "%.1f"|format(data.position_analytics.collateral_usage.collateral_percentage) }}%
                                        </div>
                                        <small class="text-muted">Collateral %</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="text-center">
                                        <div class="h4 mb-1 text-success">${{ "%.2f"|format(data.position_analytics.collateral_usage.available_capital) }}</div>
                                        <small class="text-muted">Available Capital</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Collateral Usage</small>
                                    <small>{{ "%.1f"|format(data.position_analytics.collateral_usage.collateral_percentage) }}%</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar {% if data.position_analytics.collateral_usage.collateral_percentage > 50 %}bg-danger{% elif data.position_analytics.collateral_usage.collateral_percentage > 30 %}bg-warning{% else %}bg-success{% endif %}"
                                         role="progressbar"
                                         style="width: {{ data.position_analytics.collateral_usage.collateral_percentage }}%"
                                         aria-valuenow="{{ data.position_analytics.collateral_usage.collateral_percentage }}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        {% if data.position_analytics.collateral_usage.collateral_percentage > 50 %}
                                            ⚠️ High collateral usage - Consider reducing position sizes
                                        {% elif data.position_analytics.collateral_usage.collateral_percentage > 30 %}
                                            ⚡ Moderate collateral usage - Monitor closely
                                        {% else %}
                                            ✅ Healthy collateral usage - Room for additional positions
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Position Breakdown -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Position Types</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Long Positions:</span>
                                        <span class="badge bg-success">{{ data.position_analytics.long_positions }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Short Positions:</span>
                                        <span class="badge bg-danger">{{ data.position_analytics.short_positions }}</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Options:</span>
                                        <span class="badge bg-warning">{{ data.position_analytics.option_positions }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Stocks:</span>
                                        <span class="badge bg-info">{{ data.position_analytics.stock_positions }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-trophy"></i> Top Performers</h6>
                        </div>
                        <div class="card-body">
                            {% if data.position_analytics.most_profitable %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Most Profitable:</span>
                                <div class="text-end">
                                    <div class="text-success">{{ data.position_analytics.most_profitable.symbol }}</div>
                                    <small class="text-success">+${{ "%.2f"|format(data.position_analytics.most_profitable.pnl) }}</small>
                                </div>
                            </div>
                            {% endif %}

                            {% if data.position_analytics.least_profitable %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Least Profitable:</span>
                                <div class="text-end">
                                    <div class="text-danger">{{ data.position_analytics.least_profitable.symbol }}</div>
                                    <small class="text-danger">${{ "%.2f"|format(data.position_analytics.least_profitable.pnl) }}</small>
                                </div>
                            </div>
                            {% endif %}

                            {% if data.position_analytics.largest_position %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Largest Position:</span>
                                <div class="text-end">
                                    <div>{{ data.position_analytics.largest_position.symbol }}</div>
                                    <small>${{ "%.2f"|format(data.position_analytics.largest_position.value) }}</small>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risk Metrics -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-shield-check"></i> Risk Metrics</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 col-sm-6 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Largest Gain:</span>
                                        <span class="text-success">${{ "%.2f"|format(data.position_analytics.risk_metrics.largest_gain) }}</span>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Largest Loss:</span>
                                        <span class="text-danger">${{ "%.2f"|format(data.position_analytics.risk_metrics.largest_loss) }}</span>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Avg Position Size:</span>
                                        <span>${{ "%.2f"|format(data.position_analytics.risk_metrics.avg_position_size) }}</span>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Cost Basis:</span>
                                        <span>${{ "%.2f"|format(data.position_analytics.total_cost) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Put Analysis -->
        {% if data.put_analysis is defined and data.put_analysis.put_positions %}
        <div id="put-analysis" class="section mb-4">
            <div class="section-header d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0"><i class="bi bi-graph-down"></i> Put Analysis</h2>
                <div class="d-flex align-items-center">
                    <span class="badge bg-info me-2">Total Collateral: ${{ "%.2f"|format(data.put_analysis.total_collateral_tied) }}</span>
                    <span class="badge bg-secondary">Avg Return: {{ "%.2f"|format(data.put_analysis.avg_annualized_return) }}%</span>
                </div>
            </div>

            <!-- Risk Summary Cards -->
            {% if data.put_analysis.risk_summary is defined %}
            <div class="row mb-4">
                <div class="col-md-2 col-sm-4 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-graph-down text-warning"></i>
                            </div>
                            <h4 class="mb-1">{{ data.put_analysis.put_positions|length }}</h4>
                            <small class="text-muted">Put Positions</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 col-sm-4 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-exclamation-triangle text-danger"></i>
                            </div>
                            <h4 class="mb-1">{{ data.put_analysis.positions_to_close|length }}</h4>
                            <small class="text-muted">Should Close (< 12%)</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 col-sm-4 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-currency-dollar text-success"></i>
                            </div>
                            <h4 class="mb-1">${{ "%.2f"|format(data.put_analysis.total_collateral_tied) }}</h4>
                            <small class="text-muted">Collateral Tied</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 col-sm-4 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-percent text-info"></i>
                            </div>
                            <h4 class="mb-1">{{ "%.2f"|format(data.put_analysis.avg_annualized_return) }}%</h4>
                            <small class="text-muted">Avg Annualized Return</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 col-sm-4 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-shield-exclamation text-warning"></i>
                            </div>
                            <h4 class="mb-1">{{ data.put_analysis.risk_summary.high_risk_positions }}</h4>
                            <small class="text-muted">High Risk Positions</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-2 col-sm-4 mb-3">
                    <div class="card analytics-card h-100">
                        <div class="card-body text-center">
                            <div class="analytics-icon mb-2">
                                <i class="bi bi-percent text-info"></i>
                            </div>
                            <h4 class="mb-1">{{ "%.1f"|format(data.put_analysis.risk_summary.avg_prob_profit * 100) }}%</h4>
                            <small class="text-muted">Avg Probability of Profit</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio Risk Metrics -->
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="bi bi-shield-exclamation"></i> Portfolio Risk Metrics
                        <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Aggregated risk metrics across all put positions. Monitor these to understand overall portfolio exposure."></i>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">
                                    Total Delta
                                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                       title="Portfolio sensitivity to stock price changes. Negative values mean portfolio gains when stocks fall."></i>
                                </h5>
                                <h4 class="{% if data.put_analysis.risk_summary.total_delta < -0.5 %}text-danger{% elif data.put_analysis.risk_summary.total_delta < -0.2 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.3f"|format(data.put_analysis.risk_summary.total_delta) }}
                                </h4>
                                <small class="text-muted">Portfolio sensitivity to stock price</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">
                                    Total Gamma
                                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                       title="Rate of delta change. High gamma means delta changes rapidly with stock moves (acceleration risk)."></i>
                                </h5>
                                <h4 class="{% if data.put_analysis.risk_summary.total_gamma > 0.05 %}text-danger{% elif data.put_analysis.risk_summary.total_gamma > 0.02 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.4f"|format(data.put_analysis.risk_summary.total_gamma) }}
                                </h4>
                                <small class="text-muted">Rate of delta change</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">
                                    Total Theta
                                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                       title="Daily time decay. Negative values mean portfolio loses value each day due to time passing."></i>
                                </h5>
                                <h4 class="{% if data.put_analysis.risk_summary.total_theta < -0.1 %}text-danger{% elif data.put_analysis.risk_summary.total_theta < -0.05 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.3f"|format(data.put_analysis.risk_summary.total_theta) }}
                                </h4>
                                <small class="text-muted">Daily time decay</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">
                                    Total Vega
                                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                       title="Volatility sensitivity. High vega means portfolio value changes significantly with volatility changes."></i>
                                </h5>
                                <h4 class="{% if data.put_analysis.risk_summary.total_vega > 0.2 %}text-danger{% elif data.put_analysis.risk_summary.total_vega > 0.1 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.3f"|format(data.put_analysis.risk_summary.total_vega) }}
                                </h4>
                                <small class="text-muted">Volatility sensitivity</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Put Positions Table -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-table"></i> Put Positions Analysis
                        <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Detailed analysis of each put position including Greeks, risk levels, and closure recommendations."></i>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="putPositionsTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Strike</th>
                                    <th>Expiration</th>
                                    <th>Days Left</th>
                                    <th>Quantity</th>
                                    <th>Premium Received</th>
                                    <th>Market Value</th>
                                    <th>Current P&L</th>
                                    <th>Collateral</th>
                                    <th>Annualized Return</th>
                                    <th>
                                        Risk Level
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Risk classification based on Greeks: High (Delta>0.7, Gamma>0.02, Theta<-0.1), Medium (moderate exposure), Low (minimal exposure)"></i>
                                    </th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for put in data.put_analysis.put_positions %}
                                <tr class="{% if put.should_close %}table-danger{% elif put.annualized_return >= 20 %}table-success{% endif %}">
                                    <td><strong>{{ put.symbol }}</strong></td>
                                    <td>${{ "%.2f"|format(put.strike) }}</td>
                                    <td>{{ put.expiration }}</td>
                                    <td>
                                        <span class="badge {% if put.days_left is not none and put.days_left >= 0 and put.days_left <= 7 %}bg-danger{% elif put.days_left is not none and put.days_left >= 0 and put.days_left <= 14 %}bg-warning{% else %}bg-info{% endif %}">
                                            {{ put.days_left }} days
                                        </span>
                                    </td>
                                    <td>{{ put.quantity }}</td>
                                    <td>${{ "%.2f"|format(put.premium) }}</td>
                                    <td>${{ "%.2f"|format(put.mkt_value) }}</td>
                                    <td class="{% if put.current_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        ${{ "%.2f"|format(put.current_pnl) }}
                                    </td>
                                    <td>${{ "%.2f"|format(put.collateral) }}</td>
                                    <td>
                                        <span class="{% if put.annualized_return >= 12 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                            {{ "%.2f"|format(put.annualized_return) }}%
                                        </span>
                                    </td>
                                    <td>
                                        {% if put.risk_level is defined %}
                                            <span class="badge {% if put.risk_level == 'High' %}bg-danger{% elif put.risk_level == 'Medium' %}bg-warning{% else %}bg-success{% endif %}">
                                                {{ put.risk_level }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if put.should_close %}
                                            <span class="badge bg-danger">CLOSE</span>
                                        {% elif put.annualized_return >= 20 %}
                                            <span class="badge bg-success">HOLD</span>
                                        {% else %}
                                            <span class="badge bg-warning">MONITOR</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Close Recommendations -->
            {% if data.put_analysis.positions_to_close %}
            <div class="card mt-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i> Close Recommendations (Return < 12%) <i
                            class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Positions with annualized returns below 12% that may need closure consideration."></i>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for put in data.put_analysis.positions_to_close %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card border-danger">
                                <div class="card-body">
                                    <h6 class="card-title text-danger">{{ put.symbol }}</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Strike:</small><br>
                                            <strong>${{ "%.2f"|format(put.strike) }}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Return:</small><br>
                                            <strong class="text-danger">{{ "%.2f"|format(put.annualized_return) }}%</strong>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">Days Left:</small><br>
                                            <strong>{{ put.days_left }}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Collateral:</small><br>
                                            <strong>${{ "%.2f"|format(put.collateral) }}</strong>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">Premium:</small><br>
                                            <strong>${{ "%.2f"|format(put.premium) }}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Market Value:</small><br>
                                            <strong>${{ "%.2f"|format(put.mkt_value) }}</strong>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <small class="text-muted">Current P&L:</small><br>
                                            <strong
                                                class="{% if put.current_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                ${{ "%.2f"|format(put.current_pnl) }}
                                            </strong>
                                        </div>
                                    </div>
                                    {% if put.greeks is defined %}
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">Delta:</small><br>
                                            <strong
                                                class="{% if put.greeks.delta < -0.7 %}text-danger{% elif put.greeks.delta < -0.5 %}text-warning{% else %}text-success{% endif %}">
                                                {{ "%.3f"|format(put.greeks.delta) }}
                                            </strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Prob. Profit:</small><br>
                                            <strong
                                                class="{% if put.greeks.prob_profit > 0.7 %}text-success{% elif put.greeks.prob_profit > 0.5 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ "%.1f"|format(put.greeks.prob_profit * 100) }}%
                                            </strong>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Stock Concentration Analysis -->
            {% if data.stock_concentration is defined and data.stock_concentration.stock_concentration %}
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-pie-chart"></i> Stock Concentration Analysis
                        <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Analyze your put position allocation by stock to identify over-investment and concentration risk."></i>
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Concentration Summary -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">Total Stocks</h5>
                                <h4 class="text-primary">{{ data.stock_concentration.concentration_risk.total_stocks }}</h4>
                                <small class="text-muted">Different stocks</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">Max Concentration</h5>
                                <h4
                                    class="{% if data.stock_concentration.concentration_risk.max_concentration > 25 %}text-danger{% elif data.stock_concentration.concentration_risk.max_concentration > 15 %}text-warning{% else %}text-success{% endif %}">
                                    {{ "%.1f"|format(data.stock_concentration.concentration_risk.max_concentration) }}%
                                </h4>
                                <small class="text-muted">Highest single stock %</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">Avg Concentration</h5>
                                <h4 class="text-info">{{
                                    "%.1f"|format(data.stock_concentration.concentration_risk.avg_concentration) }}%</h4>
                                <small class="text-muted">Average per stock</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">High Risk Stocks</h5>
                                <h4
                                    class="{% if data.stock_concentration.concentration_risk.high_concentration_stocks > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ data.stock_concentration.concentration_risk.high_concentration_stocks }}
                                </h4>
                                <small class="text-muted">>25% concentration</small>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Concentration Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="stockConcentrationTable">
                            <thead>
                                <tr>
                                    <th>Stock</th>
                                    <th>
                                        % of Portfolio
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                            title="Percentage of total put collateral allocated to this stock"></i>
                                    </th>
                                    <th>Total Collateral</th>
                                    <th>Positions</th>
                                    <th>Avg Return</th>
                                    <th>Total P&L</th>
                                    <th>Avg Days Left</th>
                                    <th>
                                        Risk Level
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                            title="Concentration risk: High (>25%), Medium (15-25%), Low (<15%)"></i>
                                    </th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in data.stock_concentration.stock_concentration %}
                                <tr class="{% if stock.is_over_invested %}table-warning{% endif %}">
                                    <td><strong>{{ stock.symbol }}</strong></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                <div class="progress-bar {% if stock.percentage > 25 %}bg-danger{% elif stock.percentage > 15 %}bg-warning{% else %}bg-success{% endif %}"
                                                    style="width: {{ stock.percentage }}%"></div>
                                            </div>
                                            <span
                                                class="{% if stock.percentage > 25 %}text-danger{% elif stock.percentage > 15 %}text-warning{% else %}text-success{% endif %} fw-bold">
                                                {{ "%.1f"|format(stock.percentage) }}%
                                            </span>
                                        </div>
                                    </td>
                                    <td>${{ "%.0f"|format(stock.total_collateral) }}</td>
                                    <td>{{ stock.position_count }}</td>
                                    <td>
                                        <span
                                            class="{% if stock.avg_annualized_return >= 12 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                            {{ "%.2f"|format(stock.avg_annualized_return) }}%
                                        </span>
                                    </td>
                                    <td class="{% if stock.total_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        ${{ "%.2f"|format(stock.total_pnl) }}
                                    </td>
                                    <td>{{ "%.0f"|format(stock.avg_days_left) }} days</td>
                                    <td>
                                        <span
                                            class="badge {% if stock.risk_level == 'High' %}bg-danger{% elif stock.risk_level == 'Medium' %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ stock.risk_level }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if stock.is_over_invested %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-exclamation-triangle"></i> Over-Invested
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Balanced
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Over-Investment Alerts -->
                    {% set over_invested_stocks = data.stock_concentration.stock_concentration | selectattr('is_over_invested') |
                    list %}
                    {% if over_invested_stocks %}
                    <div class="alert alert-warning mt-3">
                        <h6 class="alert-heading">
                            <i class="bi bi-exclamation-triangle"></i> Concentration Risk Alert
                        </h6>
                        <p class="mb-2">You have <strong>{{ over_invested_stocks|length }}</strong> stock(s) with over 20%
                            concentration:</p>
                        <ul class="mb-0">
                            {% for stock in over_invested_stocks %}
                            <li><strong>{{ stock.symbol }}</strong>: {{ "%.1f"|format(stock.percentage) }}% of portfolio</li>
                            {% endfor %}
                        </ul>
                        <hr>
                        <p class="mb-0 small">
                            <strong>Recommendation:</strong> Consider reducing exposure to these stocks to diversify your risk.
                            High concentration increases vulnerability to company-specific events.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- ITM Analysis -->
            {% if data.itm_analysis is defined and data.itm_analysis.itm_positions %}
            <div class="card mt-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i> In-The-Money (ITM) Risk Analysis
                        <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Monitor put positions that are in-the-money and at risk of assignment. Take action to manage assignment risk."></i>
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Note about real stock prices -->
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading">
                            <i class="bi bi-info-circle"></i> Real-Time Stock Prices
                        </h6>
                        <p class="mb-0">
                            ITM analysis uses real-time stock prices from IBKR market data for accurate detection.
                            Only positions with available stock price data are shown in this analysis.
                        </p>
                    </div>

                    <!-- ITM Summary -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">ITM Positions</h5>
                                <h4 class="text-danger">{{ data.itm_analysis.itm_summary.total_itm_positions }}</h4>
                                <small class="text-muted">In-the-money puts</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">High Risk ITM</h5>
                                <h4
                                    class="{% if data.itm_analysis.high_risk_itm > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ data.itm_analysis.high_risk_itm }}
                                </h4>
                                <small class="text-muted">Critical/High risk</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">Assignment Risk</h5>
                                <h4
                                    class="{% if data.itm_analysis.assignment_risk > 1000 %}text-danger{% elif data.itm_analysis.assignment_risk > 500 %}text-warning{% else %}text-success{% endif %}">
                                    ${{ "%.0f"|format(data.itm_analysis.assignment_risk) }}
                                </h4>
                                <small class="text-muted">Potential assignment cost</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <h5 class="text-muted mb-1">Deep ITM</h5>
                                <h4
                                    class="{% if data.itm_analysis.itm_summary.deep_itm_positions > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ data.itm_analysis.itm_summary.deep_itm_positions }}
                                </h4>
                                <small class="text-muted">>$3 below strike</small>
                            </div>
                        </div>
                    </div>

                    <!-- Critical ITM Alerts -->
                    {% set critical_itm = data.itm_analysis.itm_positions | selectattr('risk_level', 'equalto', 'Critical') | list
                    %}
                    {% if critical_itm %}
                    <div class="alert alert-danger mb-4">
                        <h6 class="alert-heading">
                            <i class="bi bi-exclamation-triangle-fill"></i> CRITICAL ITM ALERT
                        </h6>
                        <p class="mb-2">You have <strong>{{ critical_itm|length }}</strong> critical ITM position(s) requiring
                            immediate action:</p>
                        <div class="row">
                            {% for position in critical_itm %}
                            <div class="col-md-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 border border-danger rounded">
                                    <div>
                                        <strong class="text-danger">{{ position.symbol }}</strong> - ${{
                                        "%.2f"|format(position.strike) }}
                                        <br>
                                        <small class="text-muted">
                                            Stock: ${{ "%.2f"|format(position.current_stock_price) }} |
                                            Distance: ${{ "%.2f"|format(position.distance_from_strike) }} |
                                            {{ position.days_left }} days left
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <div class="text-danger fw-bold">{{ position.action }}</div>
                                        <small class="text-muted">Risk: ${{ "%.0f"|format(position.assignment_value) }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <hr>
                        <p class="mb-0 small">
                            <strong>IMMEDIATE ACTION REQUIRED:</strong> Close these positions or roll to further strikes/dates to
                            avoid assignment.
                        </p>
                    </div>
                    {% endif %}

                    <!-- ITM Positions Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="itmAnalysisTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>
                                        Strike vs Stock
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                            title="Strike price vs current stock price. Red indicates ITM status."></i>
                                    </th>
                                    <th>Distance from Strike</th>
                                    <th>Days Left</th>
                                    <th>Assignment Value</th>
                                    <th>Potential Loss</th>
                                    <th>
                                        Risk Level
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                            title="ITM risk: Critical (deep ITM + near expiry), High (moderate ITM + near expiry), Medium (ITM + some time), Low (slight ITM)"></i>
                                    </th>
                                    <th>Action Required</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for position in data.itm_analysis.itm_positions %}
                                <tr
                                    class="{% if position.risk_level == 'Critical' %}table-danger{% elif position.risk_level == 'High' %}table-warning{% endif %}">
                                    <td><strong>{{ position.symbol }}</strong></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="text-muted me-2">${{ "%.2f"|format(position.current_stock_price) }}</span>
                                            <i class="bi bi-arrow-right text-danger"></i>
                                            <span class="text-danger fw-bold ms-2">${{ "%.2f"|format(position.strike) }}</span>
                                        </div>
                                        <small class="text-danger">ITM by {{ "%.1f"|format(position.itm_percentage) }}%</small>
                                    </td>
                                    <td>
                                        <span
                                            class="{% if position.distance_from_strike > 5 %}text-danger{% elif position.distance_from_strike > 3 %}text-warning{% else %}text-info{% endif %} fw-bold">
                                            ${{ "%.2f"|format(position.distance_from_strike) }}
                                        </span>
                                    </td>
                                    <td>
                                        <span
                                            class="badge {% if position.days_left is not none and position.days_left >= 0 and position.days_left <= 3 %}bg-danger{% elif position.days_left is not none and position.days_left >= 0 and position.days_left <= 7 %}bg-warning{% else %}bg-info{% endif %}">
                                            {{ position.days_left }} days
                                        </span>
                                    </td>
                                    <td class="text-danger fw-bold">${{ "%.0f"|format(position.assignment_value) }}</td>
                                    <td class="{% if position.potential_loss > 0 %}text-danger{% else %}text-success{% endif %}">
                                        ${{ "%.0f"|format(position.potential_loss) }}
                                    </td>
                                    <td>
                                        <span
                                            class="badge {% if position.risk_level == 'Critical' %}bg-danger{% elif position.risk_level == 'High' %}bg-warning{% elif position.risk_level == 'Medium' %}bg-info{% else %}bg-success{% endif %}">
                                            {{ position.risk_level }}
                                        </span>
                                    </td>
                                    <td>
                                        <span
                                            class="badge {% if position.action_urgency == 'critical' %}bg-danger{% elif position.action_urgency == 'high' %}bg-warning{% elif position.action_urgency == 'medium' %}bg-info{% else %}bg-secondary{% endif %}">
                                            {{ position.action }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- ITM Risk Management Tips -->
                    <div class="alert alert-info mt-3">
                        <h6 class="alert-heading">
                            <i class="bi bi-lightbulb"></i> ITM Risk Management Strategies
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>For Critical/High Risk Positions:</strong>
                                <ul class="mb-0">
                                    <li>Close position immediately to avoid assignment</li>
                                    <li>Roll to a lower strike price</li>
                                    <li>Roll to a later expiration date</li>
                                    <li>Consider buying back the put</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <strong>For Medium/Low Risk Positions:</strong>
                                <ul class="mb-0">
                                    <li>Monitor stock price movement closely</li>
                                    <li>Set stop-loss orders</li>
                                    <li>Prepare rolling strategy</li>
                                    <li>Consider partial position closure</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Enhanced Risk Analysis -->
            {% if data.put_analysis.put_positions and data.put_analysis.put_positions[0].greeks is defined %}
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-shield-check"></i> Advanced Risk Analysis
                        <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="Detailed Greeks analysis for each put position. These metrics help understand position sensitivity to market changes."></i>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="riskAnalysisTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>
                                        Delta
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Position sensitivity to stock price. For puts: -1 to 0. Negative values mean position gains when stock falls."></i>
                                    </th>
                                    <th>
                                        Gamma
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Rate of delta change. High gamma means delta changes rapidly with stock moves (acceleration risk)."></i>
                                    </th>
                                    <th>
                                        Theta (Daily)
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Daily time decay. Negative values mean position loses value each day due to time passing."></i>
                                    </th>
                                    <th>
                                        Vega
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Volatility sensitivity. High vega means position value changes significantly with volatility changes."></i>
                                    </th>
                                    <th>
                                        Prob. Profit
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Statistical probability of profit at expiration based on current market conditions."></i>
                                    </th>
                                    <th>
                                        Implied Vol
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Market's expectation of future volatility, inferred from option prices."></i>
                                    </th>
                                    <th>
                                        Stock Price
                                        <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                           title="Real-time stock price from IBKR market data. Used for accurate ITM detection and Greeks calculations."></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for put in data.put_analysis.put_positions %}
                                {% if put.greeks is defined %}
                                <tr>
                                    <td><strong>{{ put.symbol }}</strong></td>
                                    <td class="{% if put.greeks.delta < -0.7 %}text-danger{% elif put.greeks.delta < -0.5 %}text-warning{% else %}text-success{% endif %}">
                                        {{ "%.3f"|format(put.greeks.delta) }}
                                    </td>
                                    <td class="{% if put.greeks.gamma > 0.02 %}text-danger{% elif put.greeks.gamma > 0.01 %}text-warning{% else %}text-success{% endif %}">
                                        {{ "%.4f"|format(put.greeks.gamma) }}
                                    </td>
                                    <td class="{% if put.greeks.theta < -0.1 %}text-danger{% elif put.greeks.theta < -0.05 %}text-warning{% else %}text-success{% endif %}">
                                        {{ "%.3f"|format(put.greeks.theta) }}
                                    </td>
                                    <td class="{% if put.greeks.vega > 0.1 %}text-danger{% elif put.greeks.vega > 0.05 %}text-warning{% else %}text-success{% endif %}">
                                        {{ "%.3f"|format(put.greeks.vega) }}
                                    </td>
                                    <td class="{% if put.greeks.prob_profit > 0.7 %}text-success{% elif put.greeks.prob_profit > 0.5 %}text-warning{% else %}text-danger{% endif %}">
                                        {{ "%.1f"|format(put.greeks.prob_profit * 100) }}%
                                    </td>
                                    <td>{{ "%.1f"|format(put.greeks.implied_vol * 100) }}%</td>
                                    <td>
                                        {% if put.current_stock_price is not none %}
                                            ${{ "%.2f"|format(put.current_stock_price) }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stress Testing Scenarios -->
            {% if data.put_analysis.put_positions and data.put_analysis.put_positions[0].stress_scenarios is defined %}
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-graph-up-arrow"></i> Stress Testing Scenarios
                        <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top"
                           title="P&L projections under various market stress scenarios. Use these to understand potential losses in adverse conditions."></i>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for put in data.put_analysis.put_positions %}
                        {% if put.stress_scenarios is defined %}
                        <div class="col-lg-6 col-md-12 mb-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">{{ put.symbol }} - Stress Scenarios</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% for scenario_name, scenario in put.stress_scenarios.items() %}
                                        <div class="col-12 mb-2">
                                            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                <div>
                                                    <strong>{{ scenario.description }}</strong>
                                                    <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" data-bs-placement="top"
                                                       title="{% if scenario_name == 'stock_drop_10' %}Moderate market decline scenario{% elif scenario_name == 'stock_drop_20' %}Significant market decline scenario{% elif scenario_name == 'vol_increase_50' %}Market volatility spike scenario{% elif scenario_name == 'time_decay_week' %}One week of time decay{% else %}Large rapid price move scenario{% endif %}"></i>
                                                    <br>
                                                    <small class="text-muted">Risk:
                                                        <span class="badge {% if scenario.risk_level == 'High' %}bg-danger{% elif scenario.risk_level == 'Medium' %}bg-warning{% else %}bg-success{% endif %}">
                                                            {{ scenario.risk_level }}
                                                        </span>
                                                    </small>
                                                </div>
                                                <div class="text-end">
                                                    <div class="{% if scenario.pnl_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                        {{ "%.2f"|format(scenario.pnl_change) }}
                                                    </div>
                                                    <small class="text-muted">New P&L: ${{ "%.2f"|format(scenario.new_pnl) }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Help Button -->
            <div class="text-center mt-4">
                <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#riskMetricsHelpModal">
                    <i class="bi bi-question-circle"></i> Understanding Risk Metrics
                </button>
            </div>
        </div>
        {% endif %}


    </div>
    {% endif %}

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize DataTables
            $('#stockPositionsTable, #optionPositionsTable, #stockTransactionsTable, #optionTransactionsTable, #putPositionsTable, #riskAnalysisTable').DataTable({
                pageLength: 10,
                order: [[0, 'desc']],
                language: {
                    search: "Filter records:"
                },
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip'
            });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Smooth scrolling for navigation
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Remove active class from all nav links
                    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
                        link.classList.remove('active');
                    });

                    // Add active class to clicked link
                    this.classList.add('active');

                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });

            // Navigation highlighting based on scroll position
            function updateActiveNavLink() {
                const sections = ['overview', 'performance', 'analytics', 'put-analysis', 'positions'];
                const navLinks = document.querySelectorAll('.navbar-nav .nav-link');

                let currentSection = '';

                sections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        const rect = section.getBoundingClientRect();
                        if (rect.top <= 100 && rect.bottom >= 100) {
                            currentSection = sectionId;
                        }
                    }
                });

                // If no section is currently visible, default to overview
                if (!currentSection) {
                    currentSection = 'overview';
                }

                // Update active nav link
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#' + currentSection) {
                        link.classList.add('active');
                    }
                });
            }

            // Update active nav link on scroll
            window.addEventListener('scroll', updateActiveNavLink);

            // Initial call to set active nav link
            updateActiveNavLink();

            // Back to Top Button functionality
            const backToTopButton = document.getElementById('backToTop');

            // Show/hide button based on scroll position
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    backToTopButton.classList.add('visible');
                } else {
                    backToTopButton.classList.remove('visible');
                }
            });

            // Smooth scroll to top when button is clicked
            backToTopButton.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });

            // Start connection monitoring
            startConnectionMonitoring();
        });

        // Global functions for connection management
        function attemptReconnect() {
            const reconnectBtn = document.querySelector('button[onclick="attemptReconnect()"]');
            const originalText = reconnectBtn.innerHTML;

            // Show loading state
            reconnectBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Connecting...';
            reconnectBtn.disabled = true;

            fetch('/api/reconnect')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Connection restored!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showNotification('Reconnection failed: ' + (data.error_message || data.error), 'error');
                        reconnectBtn.innerHTML = originalText;
                        reconnectBtn.disabled = false;
                    }
                })
                .catch(error => {
                    showNotification('Reconnection failed: ' + error.message, 'error');
                    reconnectBtn.innerHTML = originalText;
                    reconnectBtn.disabled = false;
                });
        }

        function refreshData() {
            const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
            const originalText = refreshBtn.innerHTML;

            // Show loading state
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Refreshing...';
            refreshBtn.disabled = true;

            // Track refresh operation
            if (window.trackRefresh) {
                window.trackRefresh();
            }

            fetch('/api/refresh-data')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Data refreshed successfully!', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showNotification('Refresh failed: ' + (data.error || 'Unknown error'), 'error');
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }
                })
                .catch(error => {
                    showNotification('Refresh failed: ' + error.message, 'error');
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                });
        }

        function startConnectionMonitoring() {
            let lastRefreshTime = 0;
            const REFRESH_COOLDOWN = 10000; // 10 seconds cooldown after refresh

            // Check connection status every 30 seconds
            setInterval(() => {
                // Don't check connection status if we just refreshed
                const timeSinceRefresh = Date.now() - lastRefreshTime;
                if (timeSinceRefresh < REFRESH_COOLDOWN) {
                    console.log('Skipping connection check - too soon after refresh');
                    return;
                }

                fetch('/api/connection-status')
                    .then(response => response.json())
                    .then(data => {
                        updateConnectionBanner(data);
                    })
                    .catch(error => {
                        console.error('Error checking connection status:', error);
                    });
            }, 30000);

            // Track refresh operations
            window.trackRefresh = function() {
                lastRefreshTime = Date.now();
            };
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes in milliseconds
            let nextRefreshTime = Date.now() + REFRESH_INTERVAL;
            let autoRefreshEnabled = true;
            let isRefreshing = false;

            // Create refresh indicator
            const refreshIndicator = document.createElement('div');
            refreshIndicator.id = 'autoRefreshIndicator';
            refreshIndicator.className = 'position-fixed';
            refreshIndicator.style.cssText = `
                bottom: 20px;
                left: 20px;
                background: rgba(0, 123, 255, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
            `;

            function updateRefreshIndicator() {
                if (!autoRefreshEnabled) {
                    refreshIndicator.innerHTML = `
                        <i class="bi bi-pause-circle"></i>
                        <span>Auto-refresh paused</span>
                    `;
                    refreshIndicator.style.background = 'rgba(108, 117, 125, 0.9)';
                    return;
                }

                if (isRefreshing) {
                    refreshIndicator.innerHTML = `
                        <i class="bi bi-arrow-clockwise spin"></i>
                        <span>Refreshing...</span>
                    `;
                    refreshIndicator.style.background = 'rgba(255, 193, 7, 0.9)';
                    return;
                }

                const timeLeft = Math.max(0, nextRefreshTime - Date.now());
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);

                refreshIndicator.innerHTML = `
                    <i class="bi bi-clock"></i>
                    <span>Auto-refresh in ${minutes}:${seconds.toString().padStart(2, '0')}</span>
                `;
                refreshIndicator.style.background = 'rgba(0, 123, 255, 0.9)';
            }

            // Add click handler to toggle auto-refresh
            refreshIndicator.addEventListener('click', function() {
                if (isRefreshing) return; // Prevent clicking during refresh

                autoRefreshEnabled = !autoRefreshEnabled;
                if (autoRefreshEnabled) {
                    showNotification('Auto-refresh enabled', 'success');
                    nextRefreshTime = Date.now() + REFRESH_INTERVAL;
                } else {
                    showNotification('Auto-refresh paused', 'warning');
                }
                updateRefreshIndicator();
            });

            // Add indicator to page
            document.body.appendChild(refreshIndicator);

            // Update indicator every second
            const indicatorInterval = setInterval(updateRefreshIndicator, 1000);

            // Auto-refresh function
            function performAutoRefresh() {
                if (!autoRefreshEnabled || isRefreshing) return;

                isRefreshing = true;
                console.log('Performing auto-refresh...');

                // Show notification
                showNotification('Auto-refreshing data...', 'info');

                // Track refresh operation
                if (window.trackRefresh) {
                    window.trackRefresh();
                }

                // Temporarily hide connection banner during refresh
                const banner = document.getElementById('connectionBanner');
                if (banner) {
                    banner.style.opacity = '0.5';
                }

                // Perform refresh
                fetch('/api/refresh-data')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Data auto-refreshed successfully!', 'success');

                            // Delay the page reload to allow user to see success message
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            showNotification('Auto-refresh failed: ' + (data.error || 'Unknown error'), 'error');
                            isRefreshing = false;

                            // Restore connection banner
                            if (banner) {
                                banner.style.opacity = '1';
                            }
                        }
                    })
                    .catch(error => {
                        showNotification('Auto-refresh failed: ' + error.message, 'error');
                        isRefreshing = false;

                        // Restore connection banner
                        if (banner) {
                            banner.style.opacity = '1';
                        }
                    });

                // Schedule next refresh
                nextRefreshTime = Date.now() + REFRESH_INTERVAL;
            }

            // Set up auto-refresh interval
            const refreshInterval = setInterval(performAutoRefresh, REFRESH_INTERVAL);

            // Initial update
            updateRefreshIndicator();

            // Cleanup function (can be called if needed)
            window.stopAutoRefresh = function() {
                clearInterval(refreshInterval);
                clearInterval(indicatorInterval);
                if (refreshIndicator.parentNode) {
                    refreshIndicator.remove();
                }
            };
        }

        // Start auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
        });

        function updateConnectionBanner(status) {
            const banner = document.getElementById('connectionBanner');
            if (!banner) return;

            const isConnected = status.connected;

            // Don't show red banner if we're currently refreshing
            const refreshIndicator = document.getElementById('autoRefreshIndicator');
            const isCurrentlyRefreshing = refreshIndicator &&
                refreshIndicator.innerHTML.includes('Refreshing...');

            if (!isConnected && isCurrentlyRefreshing) {
                console.log('Skipping red banner update - currently refreshing');
                return;
            }

            const alertClass = isConnected ? 'alert-success' : 'alert-danger';
            const iconClass = isConnected ? 'bi-wifi' : 'bi-wifi-off';

            // Update banner appearance
            banner.className = `alert ${alertClass} alert-dismissible fade show`;

            // Update content
            const content = banner.querySelector('.d-flex');
            if (content) {
                const statusText = isConnected ? 'Connected' : 'Disconnected';
                const errorText = status.error_message ? ` - ${status.error_message}` : '';
                const retryText = status.retry_count > 0 ? ` (Retry count: ${status.retry_count})` : '';
                const gatewayUrl = status.gateway_url || 'http://localhost:5001';

                content.innerHTML = `
                    <div>
                        <i class="bi ${iconClass}"></i>
                        <strong>IBKR Connection:</strong>
                        ${statusText}${errorText}
                        ${retryText ? `<small class="ms-2">${retryText}</small>` : ''}
                    </div>
                    <div>
                        ${!isConnected ? `<button type="button" class="btn btn-sm btn-outline-light me-2" onclick="attemptReconnect()"><i class="bi bi-arrow-clockwise"></i> Reconnect</button>
                        <a href="${gatewayUrl}" target="_blank" class="btn btn-sm btn-outline-light me-2"><i class="bi bi-box-arrow-up-right"></i> IBKR Login</a>` : ''}
                        <button type="button" class="btn btn-sm btn-outline-light" onclick="refreshData()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    </div>
                `;
            }
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>

    <!-- Risk Metrics Help Modal -->
    <div class="modal fade" id="riskMetricsHelpModal" tabindex="-1" aria-labelledby="riskMetricsHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="riskMetricsHelpModalLabel">
                        <i class="bi bi-shield-check"></i> Understanding Risk Metrics & Greeks
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="bi bi-graph-up"></i> The Greeks Explained</h6>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>Delta (Δ)</strong> - Price Sensitivity
                                </div>
                                <div class="card-body">
                                    <p><strong>What it measures:</strong> How much your option position value changes when the underlying stock price changes by $1.</p>
                                    <p><strong>For Put Options:</strong> Ranges from -1 to 0</p>
                                    <ul>
                                        <li><strong>Delta = -0.8:</strong> Position gains $0.80 when stock drops $1</li>
                                        <li><strong>Delta = -0.2:</strong> Position gains $0.20 when stock drops $1</li>
                                        <li><strong>Near expiration:</strong> Delta approaches -1 for in-the-money puts</li>
                                    </ul>
                                    <p><strong>Risk Level:</strong> High if |Delta| > 0.7</p>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>Gamma (Γ)</strong> - Acceleration Risk
                                </div>
                                <div class="card-body">
                                    <p><strong>What it measures:</strong> How quickly Delta changes when the stock price moves.</p>
                                    <p><strong>Key Insight:</strong> High Gamma means your position's sensitivity changes rapidly.</p>
                                    <ul>
                                        <li><strong>High Gamma (>0.02):</strong> Delta changes rapidly with stock moves</li>
                                        <li><strong>Low Gamma (<0.01):</strong> Delta changes slowly</li>
                                        <li><strong>Peak Gamma:</strong> Highest near expiration for at-the-money options</li>
                                    </ul>
                                    <p><strong>Risk Level:</strong> High if Gamma > 0.02</p>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>Theta (Θ)</strong> - Time Decay
                                </div>
                                <div class="card-body">
                                    <p><strong>What it measures:</strong> How much your option loses value each day due to time passing.</p>
                                    <p><strong>Always Negative:</strong> Options lose value over time (time decay).</p>
                                    <ul>
                                        <li><strong>Theta = -0.1:</strong> Position loses $0.10 per day</li>
                                        <li><strong>Accelerates:</strong> Time decay increases as expiration approaches</li>
                                        <li><strong>ATM Options:</strong> Highest time decay near expiration</li>
                                    </ul>
                                    <p><strong>Risk Level:</strong> High if Theta < -0.1</p>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>Vega (ν)</strong> - Volatility Sensitivity
                                </div>
                                <div class="card-body">
                                    <p><strong>What it measures:</strong> How much your option value changes when implied volatility changes by 1%.</p>
                                    <p><strong>Volatility Impact:</strong> Higher volatility = higher option prices.</p>
                                    <ul>
                                        <li><strong>High Vega (>0.1):</strong> Position very sensitive to volatility changes</li>
                                        <li><strong>Low Vega (<0.05):</strong> Position less sensitive to volatility</li>
                                        <li><strong>Peak Vega:</strong> Highest for at-the-money options</li>
                                    </ul>
                                    <p><strong>Risk Level:</strong> High if Vega > 0.1</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-success"><i class="bi bi-graph-up-arrow"></i> Risk Management</h6>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>Probability of Profit</strong>
                                </div>
                                <div class="card-body">
                                    <p><strong>What it measures:</strong> Statistical likelihood of making a profit at expiration.</p>
                                    <p><strong>Calculation:</strong> Based on Black-Scholes model and current market conditions.</p>
                                    <ul>
                                        <li><strong>>70%:</strong> High probability of profit (Green)</li>
                                        <li><strong>50-70%:</strong> Moderate probability (Yellow)</li>
                                        <li><strong><50%:</strong> Low probability (Red)</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>Risk Level Classification</strong>
                                </div>
                                <div class="card-body">
                                    <p><strong>High Risk:</strong></p>
                                    <ul>
                                        <li>Delta > 0.7 (high price sensitivity)</li>
                                        <li>Gamma > 0.02 (high acceleration risk)</li>
                                        <li>Theta < -0.1 (high time decay)</li>
                                    </ul>
                                    <p><strong>Medium Risk:</strong></p>
                                    <ul>
                                        <li>Delta 0.5-0.7</li>
                                        <li>Gamma 0.01-0.02</li>
                                        <li>Theta -0.05 to -0.1</li>
                                    </ul>
                                    <p><strong>Low Risk:</strong></p>
                                    <ul>
                                        <li>Delta < 0.5</li>
                                        <li>Gamma < 0.01</li>
                                        <li>Theta > -0.05</li>
                                    </ul>
                                </div>
                            </div>

                            <h6 class="text-warning"><i class="bi bi-exclamation-triangle"></i> Stress Testing Scenarios</h6>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>Market Stress Scenarios</strong>
                                </div>
                                <div class="card-body">
                                    <p><strong>Stock Drop 10%:</strong> Moderate market decline impact</p>
                                    <p><strong>Stock Drop 20%:</strong> Significant market decline impact</p>
                                    <p><strong>Volatility +50%:</strong> Market volatility spike impact</p>
                                    <p><strong>Time Decay (1 week):</strong> Value erosion over 7 days</p>
                                    <p><strong>Gamma Risk:</strong> Impact of large, rapid price moves</p>
                                    <p><em>These scenarios help you understand potential losses in adverse market conditions.</em></p>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <strong>Portfolio Risk Metrics</strong>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total Delta:</strong> Overall portfolio sensitivity to stock price changes</p>
                                    <p><strong>Total Gamma:</strong> Portfolio acceleration risk from large moves</p>
                                    <p><strong>Total Theta:</strong> Daily time decay across all positions</p>
                                    <p><strong>Total Vega:</strong> Portfolio volatility exposure</p>
                                    <p><strong>High Risk Positions:</strong> Count of positions requiring close attention</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="bi bi-lightbulb"></i> Pro Tips</h6>
                                <ul class="mb-0">
                                    <li><strong>Monitor High Gamma:</strong> Positions with high gamma can experience rapid P&L changes</li>
                                    <li><strong>Watch Theta:</strong> As expiration approaches, time decay accelerates</li>
                                    <li><strong>Balance Vega:</strong> High vega positions are sensitive to volatility changes</li>
                                    <li><strong>Use Stress Tests:</strong> Regularly review stress scenarios to understand worst-case outcomes</li>
                                    <li><strong>Risk Levels:</strong> Focus attention on High and Medium risk positions</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button type="button" class="back-to-top" id="backToTop" title="Back to Top">
        <i class="bi bi-arrow-up"></i>
    </button>
</body>
</html>

